<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Viewer.Query </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Viewer.Query ">
    <meta name="generator" content="docfx 2.37.2.0">
    
    <link rel="shortcut icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../styles/docfx.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <meta property="docfx:navrel" content="../../toc">
    <meta property="docfx:tocrel" content="../toc">
    
    
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
                <ul class="nav level1 navbar-nav">
                  <li class="active">
                    <a href="../../articles/intro.html" title="Articles" class="active">Articles</a>
                  </li>
                  <li class="">
                    <a href="../../api/index.html" title="API Documentation" class="">API Documentation</a>
                  </li>
                </ul>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div>
              <div class="sidefilter">
                <form class="toc-filter">
                  <span class="glyphicon glyphicon-filter filter-icon"></span>
                  <input type="text" id="toc_filter_input" placeholder="Enter here to filter..." onkeypress="if(event.keyCode==13) {return false;}">
                </form>
              </div>
              <div class="sidetoc">
                <div class="toc" id="toc">
                  
                  <ul class="nav level1">
                    <li class="">
                      <span class="expand-stub"></span>
                      <a href="../intro.html" title="Introduction" class="">Introduction</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../user/ui-overview.html" title="UI overview" class="">UI overview</a>
                          </li>
                          <li class="">
                            <a href="../user/query.html" title="Query language" class="">Query language</a>
                          </li>
                        </ul>  </li>
                    <li class="">
                      <span class="expand-stub"></span>
                      <a class="">Developer manual</a>
                        
                        <ul class="nav level2">
                          <li class="">
                            <a href="../developer/getting-started.html" title="Getting started" class="">Getting started</a>
                          </li>
                          <li class="">
                            <a href="../developer/overview.html" title="Application structure overview" class="">Application structure overview</a>
                          </li>
                          <li class="">
                            <a href="../developer/data.html" title="Viewer.Data" class="">Viewer.Data</a>
                          </li>
                          <li class="active">
                            <a href="../developer/query.html" title="Viewer.Query" class="active">Viewer.Query</a>
                          </li>
                          <li class="">
                            <a href="../developer/gui.html" title="Viewer" class="">Viewer</a>
                          </li>
                        </ul>  </li>
                  </ul>        </div>
              </div>
            </div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="viewerquery">Viewer.Query</h1>

<h2 id="compilation">Compilation</h2>
<p>Expressions in the <code>where</code> part and the <code>order by</code> part of the query are compiled to a C# code using <a href="https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/expression-trees/">Expression Trees</a>. Since we don't know the type of an attribute, many decisions have to be made at runtime. The generated code will therefore mostly just call runtime functions. Expression trees are used mainly for convenience (no need to write an interpreter).</p>
<p>The compiled function takes an <a class="xref" href="../../api/Viewer.Data.IEntity.html">entity</a> and returns a <a class="xref" href="../../api/Viewer.Data.BaseValue.html">value</a>. If the returned value in the <code>where</code> part of a query is null (i.e., <a class="xref" href="../../api/Viewer.Data.BaseValue.html#Viewer_Data_BaseValue_IsNull">IsNull</a> is true), it is interpreted as <code>fales</code> (i.e., the entity is not included in the result).</p>
<h2 id="execution">Execution</h2>
<p>Queries are executed lazily by calling the <a class="xref" href="../../api/Viewer.Query.IExecutableQuery.html">Execute</a> method. It returns an enumerator which loads entities. Even queries which contain <code>UNION</code>, <code>EXCEPT</code> and <code>INTERSECT</code> operators are evaluated lazily. This is possible due to the <a class="xref" href="../../api/Viewer.Query.IExecutableQuery.html">Match</a> method which can determine statically (i.e., without looking at any other entity) whether or not an entity matches given query.</p>
<div class="NOTE">
<h5>Note</h5>
<p>Returned entities are not sorted. This allows for a lazy execution even if the evaluated query is ordered and it drastically reduces latency since user does not have to wait for the query to search all entities.</p>
</div>
<p>The <a class="xref" href="../../api/Viewer.Query.IExecutableQuery.html">Execute</a> method supports standard cancellation and progress even though it is not an async method and it executes completely synchronously.</p>
<h3 id="search-order">Search order</h3>
<p>When we first see a directory, we don't know much about the files it contains. The program will just simply search all files there in a BFS order. Performance of this approach depends on file distribution in said direcotry. If we are lucky, all files from the result set will be in the first searched folder. Unfortunately, we could also be really unlucky and all files from the result set will be in the last direcotry.</p>
<p>So, it wouldn't be a good idea to search the same folder in a BFS order again but what should we do about it? We could remember the distribution of individual attribute names and use that. Consider this example of a possible query predicate: <code>a and not b</code>. What if we knew <code>a</code> and <code>b</code> is there is a 1000 times? Well, we don't know much about <code>a and not b</code>, since in the best case none of the files with <code>a</code> contain <code>b</code>, but in the worst case all of them do. It would be wrong to assume <code>a</code> and <code>b</code> independent without additinal information. That's why the query evaluator remembers distribution of attribute name subsets rather than individual attribute names. We can afford to do that because, in a typical situation, the number of used subsets is linear with the number of used attribute names and we don't have to wory about subsets which are not used.</p>
<h3 id="we-know-the-distribution-what-now">We know the distribution. What now?</h3>
<p>We have to come up with an optimal search order of directories. The query evaluator looks at the query predicate and detemrines which attribute name subsets will likely cause the predicate to evaluate to true. Note, we still don't know for sure whether the predicate evaluates to true for given subset since it could have a form: <code>a = &quot;value&quot;</code>. We do know, however, that all subsets we have eliminated using this process will evaluate to false (unless user defines a custom function like <code>rand</code>). Finally, we can just add up the numbers since they represent sizes of disjoint sets. This will be our search priority.</p>
<h2 id="grammar">Grammar</h2>
<p>The program uses ANTLR4 to generate query parser and lexer.</p>
<pre><code class="lang-csharp" name="Grammar">parser grammar QueryParser;

options {
  tokenVocab=QueryLexer;
}

entry: queryExpression EOF;

// set operations on queries
queryExpression: queryExpression UNION_EXCEPT intersection | intersection;

intersection: queryFactor (INTERSECT queryFactor)*;

queryFactor: query | LPAREN queryExpression RPAREN;

// query
query: unorderedQuery optionalOrderBy;

unorderedQuery: SELECT source optionalWhere;

source: ID | COMPLEX_ID | STRING | LPAREN queryExpression RPAREN;

// WHERE
optionalWhere: WHERE predicate | ;

// ORDER BY
optionalOrderBy: ORDER BY orderByList | ;

orderByList: orderByKey (PARAM_DELIMITER orderByKey)*;

orderByKey: comparison optionalDirection;

optionalDirection: DIRECTION | ;

// expressions
predicate: predicate OR conjunction | conjunction;

conjunction: conjunction AND literal | literal; 

literal: comparison | NOT comparison;

comparison: expression REL_OP expression | expression;

expression: expression ADD_SUB multiplication | multiplication; 

multiplication: multiplication MULT_DIV factor | factor;

factor: LPAREN predicate RPAREN | INT | REAL | STRING | COMPLEX_ID | ID | ID LPAREN argumentList RPAREN;

argumentList: comparison (PARAM_DELIMITER comparison)* | ;
</code></pre></article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/trylock/viewer/blob/optimizations/src/docs/articles/developer/query.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            
            <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>
  </body>
</html>
